> Build django docker image: [Django build](../README.md)

# Amazon Web Services (AWS)

> Reference: [AWS Free Tier](https://aws.amazon.com/free)

- Root user sign in: [AWS Management Console](https://aws.amazon.com/console/)

## Identity and Access Management (IAM)

> Reference: [AWS Identity and Access Management (IAM)](https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html)

AWS Identity and Access Management (IAM) is a web service that helps you securely control access to AWS resources. With IAM, you can manage permissions that control which AWS resources users can access. You use IAM to control who is authenticated (signed in) and authorized (has permissions) to use resources. IAM provides the infrastructure necessary to control authentication and authorization for your AWS accounts.

### Create a new user

- IAM / Users / Add user
  * Specify user details:
    * User name: `proupsauser`
    * Provide user access to the AWS Management Console
      * I want to create an IAM user
    * Autogenerated password
    * Users must create a new password at next sign-in - Recommended
  * Set permissions:
    * Attach existing policies directly
      * AdministratorAccess
  * Review and create user
  * Retrieve password:
    * Console sign-in URL: `https://<ACCOUNT_ID>.signin.aws.amazon.com/console`
    * User name: `proupsauser`
    * Console password: SAVE YOUR PASSWORD

- Sign in with the new user and change the password

- IAM / Users / `proupsauser` / Security credentials / Create access key
  * Access key best practices & alternatives
    * Command Line Interface (CLI)
    * I understand the above recommendation and want to proceed to create an access key.
  * Retrieve access keys:
    * Access key: SAVE YOUR ACCESS KEY (AWS_ACCESS_KEY_ID)
    * Secret access key: SAVE YOUR SECRET ACCESS KEY (AWS_SECRET_ACCESS_KEY)

## Installing the AWS CLI

> Reference: [Installing the AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html)

## AWS CLI Docker image

> Reference: [AWS CLI Docker image](https://hub.docker.com/r/amazon/aws-cli)

```bash
docker run --rm -it amazon/aws-cli bash
```

## AWS CLI login commands

> Reference: [Run aws configure](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html)

- Login with user/password:

```bash
aws configure
```
AWS Access Key ID: `AWS_ACCESS_KEY_ID`
AWS Secret Access Key: `AWS_SECRET_ACCESS_KEY`
Default region name: `eu-west-1` (Ireland)
Default output format: `json`

- Login with environment variables:

```bash
export AWS_ACCESS_KEY_ID=AWS_ACCESS_KEY_ID
export AWS_SECRET_ACCESS_KEY=AWS_SECRET_ACCESS_KEY
export AWS_DEFAULT_REGION=eu-west-1
```

# Elastic Container Registry (ECR)

> Reference: [Amazon Elastic Container Registry (ECR)](https://aws.amazon.com/ecr)

Amazon Elastic Container Registry (ECR) is a fully managed container registry that makes it easy to store, manage, share and deploy your container images and artifacts anywhere.

## Pricing

> Reference: [Amazon Elastic Container Registry (ECR) Pricing](https://aws.amazon.com/ecr/pricing)

As a new Amazon ECR customer, you get 500 MB per month of storage for your private repositories for one year as part of the AWS Free Tier.

## Create a new repository

- Elastic Container Registry / Create a repository
  * Repository name: `cloud-django`
  * Image tag mutability: `Mutable`
  * Create repository

- URI created: `<ACCOUNT_ID>.dkr.ecr.<REGION>.amazonaws.com/<REPOSITORY>`
  * Example: `985539770271.dkr.ecr.eu-west-1.amazonaws.com/cloud-django`

```bash
aws ecr create-repository --repository-name cloud-django
```

## Configure authentication to ECR for Docker

> Reference: [Private registry authentication in Amazon ECR](https://docs.aws.amazon.com/AmazonECR/latest/userguide/registry_auth.html)

> Account registry URI: `<ACCOUNT_ID>.dkr.ecr.<REGION>.amazonaws.com`

```bash
aws ecr get-login-password --region eu-west-1 | docker login --username AWS --password-stdin 985539770271.dkr.ecr.eu-west-1.amazonaws.com
```

## Docker push to registry

- Docker tag:

> Format: `<ACCOUNT_ID>.dkr.ecr.<REGION>.amazonaws.com/<REPOSITORY>:<TAG>`

```bash
docker tag cloud-django:latest 985539770271.dkr.ecr.eu-west-1.amazonaws.com/cloud-django:latest
```

- Docker push:

```bash
docker push 985539770271.dkr.ecr.eu-west-1.amazonaws.com/cloud-django:latest
```

- Artifacts list:

```bash
aws ecr list-images --repository-name cloud-django
```

# Virtual Private Cloud (VPC)

> Reference: [VPC documentation](https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html)

A VPC is a virtual network that closely resembles a traditional network that you'd operate in your own data center. After you create a VPC, you can add subnets.

## Create a VPC

> An default VPC is created when you create an AWS account. You can create additional VPCs.

- VPC / Your VPCs / Create VPC
  * Name tag - optional: `proupsa-vpc`
  * IPv4 CIDR manual input: `10.0.0.0/16`
  * No IPv6 CIDR block
  * Tenancy: `Default`
  * Create VPC

```bash
aws ec2 create-vpc --cidr-block 10.0.0.0/16 --tag-specifications 'ResourceType=vpc,Tags=[{Key=Name,Value=proupsa-vpc}]'
```

- VPC ID: `vpc-<ID>`
  * Example: `vpc-0cfb4860343c83f44`

> Route table, dhcp options set, security group and network ACL are created by default. Only interal traffic is allowed by default.

- List VPCs:

```bash
aws ec2 describe-vpcs
```

## Create a subnet

> Reference: [Subnets for your VPC](https://docs.aws.amazon.com/vpc/latest/userguide/configure-subnets.html)

A subnet is a range of IP addresses in your VPC. You can create AWS resources, such as EC2 instances, in specific subnets.

- VPC / Subnets / Create subnet
  * VPC: `proupsa-vpc`
  * Subnet name: `proupsa-subnet`
  * Availability Zone: `No preference`
  * IPv4 CIDR block: `10.0.0.0/24`
  * Create subnet

```bash
aws ec2 create-subnet --vpc-id vpc-0cfb4860343c83f44 --cidr-block 10.0.0.0/24 --tag-specifications 'ResourceType=subnet,Tags=[{Key=Name,Value=proupsa-subnet}]'
```

- Subnet ID: `subnet-<ID>`
  * Example: `subnet-048febcd087669823`

- List VPC subnets:

```bash
aws ec2 describe-subnets --filters Name=vpc-id,Values=vpc-0cfb4860343c83f44
```

## Create an internet gateway

> Reference: [Internet gateways](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Internet_Gateway.html)

An internet gateway is a horizontally scaled, redundant, and highly available VPC component that allows communication between your VPC and the internet. It supports IPv4 and IPv6 traffic. It does not cause availability risks or bandwidth constraints on your network traffic.

- VPC / Internet Gateways / Create internet gateway
  * Name tag: `proupsa-igw`
  * Create internet gateway

```bash
aws ec2 create-internet-gateway --tag-specifications 'ResourceType=internet-gateway,Tags=[{Key=Name,Value=proupsa-igw}]'
```

- Internet gateway ID: `igw-<ID>`
  * Example: `igw-0d7e090508c5232ae`

- Attach internet gateway to VPC:
  - VPC / Internet Gateways / `proupsa-igw` / Actions / Attach to VPC
    * VPC: `proupsa-vpc`
    * Attach internet gateway

```bash
aws ec2 attach-internet-gateway --vpc-id "vpc-0cfb4860343c83f44" --internet-gateway-id "igw-0d7e090508c5232ae" --region eu-west-1
```
