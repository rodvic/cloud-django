> Build django docker image: [Django build](../django/README.md)

# Amazon Web Services (AWS)

> Reference: [AWS Free Tier](https://aws.amazon.com/free)

Whether you're looking for generative AI, compute power, database storage, content delivery, or other functionality, AWS has the services to help you build sophisticated applications with increased flexibility, scalability, and reliability.

- AWS Free Tier FAQs: [AWS Free Tier FAQs](https://aws.amazon.com/free/faqs)

- Root user sign in: [AWS Management Console](https://aws.amazon.com/console/)

## Create budget alerts

> Reference: [Creating a budget](https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/budgets-create.html)

You can create budgets to track and take action on your costs and usage. You can also create budgets to track your aggregate Reserved Instance (RI) and Savings Plans utilization and coverage.

- Billing and Cost Management / Budgets / Create budget
  - Use a template (simplified)
  - Zero spend budget - Create a budget that notifies you once your spending exceeds $0.01 which is above the AWS Free Tier limits.
  - Budget name: `My Zero-Spend Budget`
  - Email recipients: `<EMAIL>`
  - Create budget

## Grant access to the billing console

> Reference: [Grant access to the billing console](https://docs.aws.amazon.com/IAM/latest/UserGuide/getting-started-account-iam.html#billing-access)

IAM users and roles in an AWS account can't access the Billing and Cost Management console by default. This is true even if they have IAM policies that grant access to certain Billing features. To grant access, the AWS account root user must first activate IAM access.

## Identity and Access Management (IAM)

> Reference: [AWS Identity and Access Management (IAM)](https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html)

AWS Identity and Access Management (IAM) is a web service that helps you securely control access to AWS resources. With IAM, you can manage permissions that control which AWS resources users can access. You use IAM to control who is authenticated (signed in) and authorized (has permissions) to use resources. IAM provides the infrastructure necessary to control authentication and authorization for your AWS accounts.

### Create a new user

- IAM / Users / Add user
  - Specify user details:
    - User name: `proupsauser`
    - Provide user access to the AWS Management Console
      - I want to create an IAM user
    - Autogenerated password
    - Users must create a new password at next sign-in - Recommended
  - Set permissions:
    - Attach existing policies directly
      - AdministratorAccess
      - AWSCostAndUsageReportAutomationPolicy
  - Review and create user
  - Retrieve password:
    - Console sign-in URL: `https://<ACCOUNT_ID>.signin.aws.amazon.com/console`
    - User name: `proupsauser`
    - Console password: SAVE YOUR PASSWORD

- Sign in with the new user and change the password

- IAM / Users / `proupsauser` / Security credentials / Create access key
  - Access key best practices & alternatives
    - Command Line Interface (CLI)
    - I understand the above recommendation and want to proceed to create an access key.
  - Retrieve access keys:
    - Access key: SAVE YOUR ACCESS KEY (AWS_ACCESS_KEY_ID)
    - Secret access key: SAVE YOUR SECRET ACCESS KEY (AWS_SECRET_ACCESS_KEY)

## AWS Regions

> Reference: [AWS Regions and Availability Zones](https://aws.amazon.com/about-aws/global-infrastructure/regions_az)

AWS has the concept of a region, which is a physical location around the world where we cluster data centers. We call each group of logical data centers an Availability Zone. Each AWS Region consists of multiple, isolated, and physically separate Availability Zones within a geographic area.

We use `eu-west-1` (Ireland) to configure aws client as `AWS_DEFAULT_REGION`. You can use --region option in the AWS CLI commands to specify another region.

In the AWS Management Console, the region selector is in the upper-right corner of the console.

```bash
export AWS_DEFAULT_REGION=eu-west-1
```

## Installing the AWS CLI

> Reference: [Installing the AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html)

This topic describes how to install or update the latest release of the AWS Command Line Interface (AWS CLI) on supported operating systems. For information on the latest releases of AWS CLI, see the AWS CLI version 2 Changelog on GitHub.

## AWS CLI login commands

> Reference: [Run aws configure](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html)

This section explains how to configure the settings that the AWS Command Line Interface (AWS CLI) uses to interact with AWS.

- Login with user/password:

```bash
aws configure
```

AWS Access Key ID: `AWS_ACCESS_KEY_ID`
AWS Secret Access Key: `AWS_SECRET_ACCESS_KEY`
Default region name: `eu-west-1` (Ireland)
Default output format: `json`

- Login with environment variables:

```bash
export AWS_ACCESS_KEY_ID=AWS_ACCESS_KEY_ID
export AWS_SECRET_ACCESS_KEY=AWS_SECRET_ACCESS_KEY
export AWS_DEFAULT_REGION=eu-west-1
```

## AWS CLI Docker image

> Reference: [AWS CLI Docker image](https://hub.docker.com/r/amazon/aws-cli)

This is a Docker image for the AWS CLI⁠. It is a unified command line tool to interact with AWS services and manage your AWS resources.

```bash
docker run --rm \
  -e AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} \
  -e AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} \
  -e AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION} \
  amazon/aws-cli help
```

# Elastic Container Registry (ECR)

> Reference: [Amazon Elastic Container Registry (ECR)](https://aws.amazon.com/ecr)

Amazon Elastic Container Registry (ECR) is a fully managed container registry that makes it easy to store, manage, share and deploy your container images and artifacts anywhere.

## ECR Pricing

> Reference: [Amazon Elastic Container Registry (ECR) Pricing](https://aws.amazon.com/ecr/pricing)

As a new Amazon ECR customer, you get 500 MB per month of storage for your private repositories for one year as part of the AWS Free Tier.

## Create a new repository

- Elastic Container Registry / Create a repository
  - Repository name: `cloud-django`
  - Image tag mutability: `Mutable`
  - Create repository

- URI created: `<ACCOUNT_ID>.dkr.ecr.<REGION>.amazonaws.com/<REPOSITORY>`
  - Example: `985539770271.dkr.ecr.eu-west-1.amazonaws.com/cloud-django`

```bash
aws ecr create-repository --repository-name cloud-django
```

## Configure authentication to ECR for Docker

> Reference: [Private registry authentication in Amazon ECR](https://docs.aws.amazon.com/AmazonECR/latest/userguide/registry_auth.html)

You can use the AWS Management Console, the AWS CLI, or the AWS SDKs to create and manage private repositories. You can also use those methods to perform some actions on images, such as listing or deleting them. These clients use standard AWS authentication methods.

- Account registry URI: `<ACCOUNT_ID>.dkr.ecr.<REGION>.amazonaws.com`

```bash
aws ecr get-login-password --region eu-west-1 | docker login --username AWS --password-stdin 985539770271.dkr.ecr.eu-west-1.amazonaws.com
```

## Docker push to registry

- Docker tag:

> Format: `<ACCOUNT_ID>.dkr.ecr.<REGION>.amazonaws.com/<REPOSITORY>:<TAG>`

```bash
docker tag cloud-django:latest 985539770271.dkr.ecr.eu-west-1.amazonaws.com/cloud-django:latest
```

- Docker push:

```bash
docker push 985539770271.dkr.ecr.eu-west-1.amazonaws.com/cloud-django:latest
```

- Artifacts list:

```bash
aws ecr list-images --repository-name cloud-django
```

# Virtual Private Cloud (VPC)

> Reference: [VPC documentation](https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html)

A VPC is a virtual network that closely resembles a traditional network that you'd operate in your own data center. After you create a VPC, you can add subnets.

## Create a VPC

> An default VPC is created when you create an AWS account. You can create additional VPCs:

- VPC / Your VPCs / Create VPC
  - Name tag - optional: `proupsa-vpc`
  - IPv4 CIDR manual input: `10.0.0.0/16`
  - No IPv6 CIDR block
  - Tenancy: `Default`
  - Create VPC

```bash
aws ec2 create-vpc --cidr-block 10.0.0.0/16 --tag-specifications 'ResourceType=vpc,Tags=[{Key=Name,Value=proupsa-vpc}]'
```

- List VPCs:

```bash
aws ec2 describe-vpcs
```

- VPC ID: `vpc-<ID>`
  - Example: `vpc-0cfb4860343c83f44`

> Route table, dhcp options set, security group and network ACL are created by default. Only interal traffic is allowed by default.

### Configure VPC DNS settings

> Reference: [DNS support in your VPC](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-dns.html)

Domain Name System (DNS) is a standard by which names used on the internet are resolved to their corresponding IP addresses. A DNS hostname is a name that uniquely and absolutely names a computer; it's composed of a host name and a domain name. DNS servers resolve DNS hostnames to their corresponding IP addresses.

> WARNING: DNS hostnames and DNS resolution is required to configure a public RDS database.

- VPC / Your VPCs / `proupsa-vpc` / Actions / Edit VPC settings
  - DNS settings
    - Enable DNS resolution: `Yes`
    - Enable DNS hostnames: `Yes`
    - Save settings

```bash
aws ec2 modify-vpc-attribute --vpc-id vpc-0cfb4860343c83f44 --enable-dns-support
aws ec2 modify-vpc-attribute --vpc-id vpc-0cfb4860343c83f44 --enable-dns-hostnames
```

### Default VPC Route table

> Reference: [Route tables](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Route_Tables.html)

A route table contains a set of rules, called routes, that determine where network traffic from your subnet or gateway is directed.

```bash
aws ec2 describe-route-tables --filters Name=vpc-id,Values=vpc-0cfb4860343c83f44
```

- Route table ID: `rtb-<ID>`
  - Example: `rtb-0fde7ac5d2dfc9922`

### Default VPC Security group

A security group controls the traffic that is allowed to reach and leave the resources that it is associated with. For example, after you associate a security group with an EC2 instance, it controls the inbound and outbound traffic for the instance.

> Reference: [Security groups for your VPC](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html)

```bash
aws ec2 describe-security-groups --filters Name=vpc-id,Values=vpc-0cfb4860343c83f44
```

- Security group ID: `sg-<ID>`
  - Example: `sg-02419826b750cd98a`

## Create subnets

> Reference: [Subnets for your VPC](https://docs.aws.amazon.com/vpc/latest/userguide/configure-subnets.html)

A subnet is a range of IP addresses in your VPC. You can create AWS resources, such as EC2 instances, in specific subnets.

> Subnets are created in a specific Availability Zone. We generally create subnets in multiple Availability Zones for high availability. Regions have multiple Availability Zones, normally three or more.

- VPC / Subnets / Create subnet
  - VPC: `proupsa-vpc`
  - Subnet name: `proupsa-subnet-1`
  - Availability Zone: `eu-west-1c`
  - IPv4 CIDR block: `10.0.0.0/24`
  - Create subnet

```bash
aws ec2 create-subnet --vpc-id vpc-0cfb4860343c83f44 --cidr-block 10.0.0.0/24 --tag-specifications 'ResourceType=subnet,Tags=[{Key=Name,Value=proupsa-subnet-1}]' --availability-zone eu-west-1c
```

- VPC / Subnets / Create subnet
  - VPC: `proupsa-vpc`
  - Subnet name: `proupsa-subnet-2`
  - Availability Zone: `eu-west-1b`
  - IPv4 CIDR block: `10.0.1.0/24`
  - Create subnet

```bash
aws ec2 create-subnet --vpc-id vpc-0cfb4860343c83f44 --cidr-block 10.0.1.0/24 --tag-specifications 'ResourceType=subnet,Tags=[{Key=Name,Value=proupsa-subnet-2}]' --availability-zone eu-west-1b
```

- VPC / Subnets / Create subnet
  - VPC: `proupsa-vpc`
  - Subnet name: `proupsa-subnet-3`
  - Availability Zone: `eu-west-1a`
  - IPv4 CIDR block: `10.0.2.0/24`
  - Create subnet

```bash
aws ec2 create-subnet --vpc-id vpc-0cfb4860343c83f44 --cidr-block 10.0.2.0/24 --tag-specifications 'ResourceType=subnet,Tags=[{Key=Name,Value=proupsa-subnet-3}]' --availability-zone eu-west-1a
```

- Subnet ID: `subnet-<ID>`
  - Example: `subnet-048febcd087669823` (eu-west-1c)
  - Example: `subnet-0906a1e5835327b69` (eu-west-1b)
  - Example: `subnet-02be1dff315c314da` (eu-west-1a)

- List VPC subnets:

```bash
aws ec2 describe-subnets --filters Name=vpc-id,Values=vpc-0cfb4860343c83f44
```

## Create an internet gateway

> Reference: [Internet gateways](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Internet_Gateway.html)

An internet gateway is a horizontally scaled, redundant, and highly available VPC component that allows communication between your VPC and the internet. It supports IPv4 and IPv6 traffic. It does not cause availability risks or bandwidth constraints on your network traffic.

- VPC / Internet Gateways / Create internet gateway
  - Name tag: `proupsa-igw`
  - Create internet gateway

```bash
aws ec2 create-internet-gateway --tag-specifications 'ResourceType=internet-gateway,Tags=[{Key=Name,Value=proupsa-igw}]'
```

- Internet gateway ID: `igw-<ID>`
  - Example: `igw-0d7e090508c5232ae`

### Attach internet gateway to VPC

- VPC / Internet Gateways / `proupsa-igw` / Actions / Attach to VPC
  - VPC: `proupsa-vpc`
  - Attach internet gateway

```bash
aws ec2 attach-internet-gateway --vpc-id "vpc-0cfb4860343c83f44" --internet-gateway-id "igw-0d7e090508c5232ae" --region eu-west-1
```

### Add route to internet gateway

- VPC / Route Tables / `rtb-0fde7ac5d2dfc9922` / Routes / Edit routes / Add route
  - Destination: `0.0.0.0/0`
  - Target: `Internet Gateway` / `proupsa-igw`
  - Save changes

```bash
aws ec2 create-route --route-table-id "rtb-0fde7ac5d2dfc9922" --destination-cidr-block "0.0.0.0/0" --gateway-id "igw-0d7e090508c5232ae"
```

# Elastic Compute Cloud (EC2)

> Reference: [Amazon EC2 documentation](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/concepts.html)

Amazon Elastic Compute Cloud (Amazon EC2) provides on-demand, scalable computing capacity in the Amazon Web Services (AWS) Cloud. Using Amazon EC2 reduces hardware costs so you can develop and deploy applications faster. You can use Amazon EC2 to launch as many or as few virtual servers as you need, configure security and networking, and manage storage.

## EC2 Pricing

> Reference: [Amazon EC2 Pricing](https://aws.amazon.com/ec2/pricing)

Free tier: In your first year of opening an AWS account, you get 750 hours per month of t2.micro instance usage (or t3.micro where t2.micro isn't available) when used with free tier AMIs, 750 hours per month of public IPv4 address usage, 30 GiB of EBS storage, 2 million I/Os, 1 GB of snapshots, and 100 GB of bandwidth to the internet.

## Create a key pair

> Reference: [Amazon EC2 key pairs](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html)

A key pair, consisting of a public key and a private key, is a set of security credentials that you use to prove your identity when connecting to an Amazon EC2 instance. For Linux instances, the private key allows you to securely SSH into your instance. For Windows instances, the private key is required to decrypt the administrator password, which you then use to connect to your instance.

- EC2 / Key Pairs / Create key pair
  - Key pair name: `proupsa-ec2-key-pair`
  - File format: `pem`
  - Create key pair

```bash
aws ec2 create-key-pair --key-name proupsa-ec2-key-pair --query 'KeyMaterial' --output text > proupsa-ec2-key-pair.pem
```

## Create an EC2 instance

- EC2 / Instances / Launch instances
  - Name and tags
    - Name: `proupsa-ec2`
  - Application and OS images (Amazon Machine Image)
    - Amazon Machine Image (AMI): `Ubuntu Server 24.04 LTS (HVM), SSD Volume Type` (Free tier eligible)
    - Architecture: `64-bit (x86)`
    - Username: `ubuntu`
  - Instance Type
    - t2.micro (Free tier eligible)
  - Key pair (login):
    - Key pair name - required: `proupsa-ec2-key-pair`
  - Network settings
    - VPC - required: `proupsa-vpc`
    - Subnet: `proupsa-subnet`
    - Auto-assign Public IP: `Enable`
    - Firewall (security group):
      - Select existing security group: `sg-02419826b750cd98a` (default)
  - Configure storage
    - Root volume size: `8 GiB` (Free tier eligible customers can get up to 30 GB of EBS General Purpose (SSD) or Magnetic storage
  - Summary
    - Number of instances: `1`
    - Launch instance

```bash
aws ec2 run-instances --image-id "ami-03fd334507439f4d1" --instance-type "t2.micro" --key-name "proupsa-ec2-key-pair" --block-device-mappings '{"DeviceName":"/dev/sda1","Ebs":{"Encrypted":false,"DeleteOnTermination":true,"Iops":3000,"SnapshotId":"snap-0f5e377686a0097e0","VolumeSize":8,"VolumeType":"gp3","Throughput":125}}' --network-interfaces '{"SubnetId":"subnet-048febcd087669823","AssociatePublicIpAddress":true,"DeviceIndex":0,"Groups":["sg-02419826b750cd98a"]}' --credit-specification '{"CpuCredits":"standard"}' --tag-specifications '{"ResourceType":"instance","Tags":[{"Key":"Name","Value":"proupsa-ec2"}]}' --metadata-options '{"HttpEndpoint":"enabled","HttpPutResponseHopLimit":2,"HttpTokens":"required"}' --private-dns-name-options '{"HostnameType":"ip-name","EnableResourceNameDnsARecord":false,"EnableResourceNameDnsAAAARecord":false}' --count "1"
```

- List EC2 instances:

```bash
aws ec2 describe-instances
```

- Instance ID: `i-<ID>`
  - Example: `i-09385e02cbc11ef61`
- Public IPv4 address:
  - Example: `3.253.30.135`
- Username: `ubuntu`

## Security group rules

> Reference: [Security group rules](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html)

Allow inbound traffic to the EC2 instance to SSH (port 22) and Django application (port 8000).

- EC2 / Security Groups / `sg-02419826b750cd98a` / Inbound rules / Edit inbound rules
  - Add rule
    - Type: `SSH`
    - Protocol: `TCP`
    - Port range: `22`
    - Source: `Anywhere`
  - Add rule
    - Type: `Custom TCP`
    - Protocol: `TCP`
    - Port range: `8000`
    - Source: `Anywhere`

```bash
aws ec2 authorize-security-group-ingress --group-id sg-02419826b750cd98a --protocol tcp --port 22 --cidr 0.0.0.0/0
aws ec2 authorize-security-group-ingress --group-id sg-02419826b750cd98a --protocol tcp --port 8000 --cidr 0.0.0.0/0
```

> WARNING: It is recommended to restrict the source IP address to your own IP address. 'Anywhere' is used for demonstration purposes. Get your IP address: [What is my IP address?](https://www.whatismyip.com)

## Connect to EC2 instance

- SSH connection:

> Format: `ssh -i proupsa-ec2-key-pair.pem ubuntu@<PUBLIC_IP>`

```bash
chmod 400 proupsa-ec2-key-pair.pem
ssh -i proupsa-ec2-key-pair.pem ubuntu@3.253.30.135
```

- Configure VM and docker run:

```bash
# root user
sudo -i

# Install docker service
apt-get update
apt-get install -y docker.io unzip

# Install awscli
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
./aws/install

# AWS login with environment variables to ECR
export AWS_ACCESS_KEY_ID=AWS_ACCESS_KEY_ID
export AWS_SECRET_ACCESS_KEY=AWS_SECRET_ACCESS_KEY
export AWS_DEFAULT_REGION=eu-west-1

# Configure authentication to ECR for Docker
aws ecr get-login-password --region eu-west-1 | docker login --username AWS --password-stdin 985539770271.dkr.ecr.eu-west-1.amazonaws.com

# Docker Run
docker run --pull always -d -p 8000:8000 985539770271.dkr.ecr.eu-west-1.amazonaws.com/cloud-django:latest
```

- Access the application:
  - URL: `http://3.253.30.135:8000`

## Terminate EC2 instance (Delete)

- EC2 / Instances / `proupsa-ec2` / Actions / Instance State / Terminate instance
  - Terminate

```bash
aws ec2 terminate-instances --instance-ids i-09385e02cbc11ef61
```

# Simple Storage Service (S3)

> Reference: [Amazon S3 documentation](https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html)

Amazon Simple Storage Service (Amazon S3) is an object storage service that offers industry-leading scalability, data availability, security, and performance. Customers of all sizes and industries can use Amazon S3 to store and protect any amount of data for a range of use cases, such as data lakes, websites, mobile applications, backup and restore, archive, enterprise applications, IoT devices, and big data analytics.

## S3 Pricing

> Reference: [Amazon S3 Pricing](https://aws.amazon.com/s3/pricing)

As part of the AWS Free Tier, you can get started with Amazon S3 for free. Upon sign-up, new AWS customers receive 5GB of Amazon S3 storage in the S3 Standard storage class; 20,000 GET Requests; 2,000 PUT, COPY, POST, or LIST Requests; and 100 GB of Data Transfer Out each month.

## Create a bucket

- S3 / Create bucket
  - AWS Region: `Europe (Ireland) eu-west-1`
  - Bucket name: `proupsa-bucket`
  - Object Ownership: `ACLs disabled (recommended)`
  - Block Public Access settings for this bucket: `Block all public access`
  - Bucket Versioning: `Disabled`
  - Default encryption:
    - Encryption type: `Server-side encryption with Amazon S3 managed keys (SSE-S3)`
    - Bucket Key: `Enable`
  - Create bucket

```bash
aws s3api create-bucket --bucket proupsa-bucket --region eu-west-1 --create-bucket-configuration LocationConstraint=eu-west-1
```

> Access only with aws credentials. No public access.

- Bucket S3 URI: `s3://<BUCKET>`
  - Example URI: `s3://proupsa-bucket`

- List S3 buckets:

```bash
aws s3api list-buckets
```

## Upload files to S3 bucket

- Upload file:
  - S3 / Buckets / `proupsa-bucket` / Upload
    - Add files
    - Upload

> Format: `aws s3 cp <FILE> s3://<BUCKET>/<FILE>`

```bash
aws s3 cp README.md s3://proupsa-bucket/README.md
```

- List bucket objects:
  - S3 / Buckets / `proupsa-bucket` / Objects

```bash
aws s3api list-objects --bucket proupsa-bucket
```

## Download files from S3 bucket

- Download file:
  - S3 / Buckets / `proupsa-bucket` / Select file / Actions / Download
    - Save file

> Format: `aws s3 cp s3://<BUCKET>/<FILE> <FILE>`

```bash
aws s3 cp s3://proupsa-bucket/README.md /tmp/README.md
```

- Output:

```json
download: s3://proupsa-bucket/README.md to /tmp/README.md
```

## Working with Mountpoint for Amazon S3 from EC2 instance

> Reference: [Working with Mountpoint for Amazon S3](https://docs.aws.amazon.com/AmazonS3/latest/userguide/mountpoint.html)

Mountpoint for Amazon S3 is a high-throughput open source file client for mounting an Amazon S3 bucket as a local file system. With Mountpoint, your applications can access objects stored in Amazon S3 through file system operations, such as open and read. Mountpoint automatically translates these operations into S3 object API calls, giving your applications access to the elastic storage and throughput of Amazon S3 through a file interface.

- SSH to EC2 instance:

```bash
ssh -i proupsa-ec2-key-pair.pem ubuntu@<PUBLIC_IP>
```

- Install and configure Mountpoint:

```bash
# root user
sudo -i

# Download Mountpoint
wget https://s3.amazonaws.com/mountpoint-s3-release/latest/x86_64/mount-s3.deb

# Install Mountpoint
apt-get update
apt-get install ./mount-s3.deb -y

# check version
mount-s3 --version

# Create a mount point
mkdir /mnt/s3

# AWS login with environment variables to ECR
export AWS_ACCESS_KEY_ID=AWS_ACCESS_KEY_ID
export AWS_SECRET_ACCESS_KEY=AWS_SECRET_ACCESS_KEY
export AWS_DEFAULT_REGION=eu-west-1

# Mount the S3 bucket
mount-s3 proupsa-bucket /mnt/s3

# List files
ls /mnt/s3

# Unmount the S3 bucket
umount /mnt/s3
```

## Delete files from S3 bucket

- Delete file:
  - S3 / Buckets / `proupsa-bucket` / Select file / Actions / Delete
    - Delete

```bash
aws s3 rm s3://proupsa-bucket/README.md
```

## Delete S3 bucket

- S3 / Buckets / Select the bucket (`proupsa-bucket`) / Actions:
  - Empty
  - Delete

```bash
# Empty bucket recursively
aws s3 rm s3://proupsa-bucket --recursive

# Delete bucket
aws s3api delete-bucket --bucket proupsa-bucket
```

# Relational Database Service (RDS)

> Reference: [Amazon RDS documentation](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Welcome.html)

Amazon Relational Database Service (Amazon RDS) is a web service that makes it easier to set up, operate, and scale a relational database in the AWS Cloud. It provides cost-efficient, resizable capacity for an industry-standard relational database and manages common database administration tasks.

## RDS Pricing

> Reference: [Amazon RDS Pricing](https://aws.amazon.com/rds/pricing)

As part of the AWS Free Tier, new AWS customers can get started with Amazon RDS for free.  Amazon RDS Free Tier includes the following each month for one year:

- Amazon RDS usage per month: 750 hours on select Single-AZ Instance databases. Usage is aggregated across instance types if using more than one instance. (Available engines: MySQL, MariaDB, PostgreSQL, or SQL Server – SQL Server Express Edition only.)
- General Purpose SSD (gp2) storage per month: 20 GB
- Storage for automated database backups per month: 20 GB

## Create a DB subnet group

> Reference: [Creating a DB subnet group](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_VPC.WorkingWithRDSInstanceinaVPC.html)

A DB subnet group is a collection of subnets (typically private) that you create in a VPC and that you then designate for your DB instances. By using a DB subnet group, you can specify a particular VPC when creating DB instances using the AWS CLI or RDS API. If you use the console, you can choose the VPC and subnet you want to use.

> WARNING: The DB subnet group must be created with subnets in different Availability Zones for high availability.

- RDS / Subnet groups / Create DB subnet group
  - Name: `proupsa-subnet-group`
  - Description: `proupsa-subnet-group`
  - VPC: `proupsa-vpc`
  - Add all subnets
  - Create

```bash
aws rds create-db-subnet-group --db-subnet-group-name proupsa-subnet-group --db-subnet-group-description proupsa-subnet-group --subnet-ids subnet-048febcd087669823 subnet-0906a1e5835327b69 subnet-02be1dff315c314da
```

## Create a database

- RDS / Create database
  - Choose a database creation method: `Standard Create`
  - Engine options
    - Engine type: `MySQL`
    - Engine version: `MySQL 8.0.40`
    - Enable RDS Extended Support: `No`
  - Templates
    - Use case: `Free tier`
  - Availability and durability
    - Single-AZ DB instance deployment (1 instance)
  - Settings
    - DB instance identifier: `proupsa-db`
    - Master username: `admin`
    - Master password: `<PASSWORD>`
  - Instance configuration
    - DB instance class: `db.t3.micro`
  - Storage
    - Storage type: `General Purpose (SSD)`
    - Allocated storage: `20 GiB`
    - Additional storage configuration
      - Enable storage autoscaling: `Disabled`
  - Connectivity
    - Virtual private cloud (VPC): `proupsa-vpc`
    - Publicly accessible: `No`
    - VPC security group (firewall): `sg-02419826b750cd98a`
    - Additional configuration
      - Database port: `3306`
  - Database authentication
    - Password authentication
  - Create database

```bash
aws rds create-db-instance --db-instance-identifier proupsa-db --db-instance-class db.t3.micro --engine mysql --engine-version 8.0.40 --allocated-storage 20 --master-username admin --master-user-password <PASSWORD> --vpc-security-group-ids sg-02419826b750cd98a --no-publicly-accessible --no-auto-minor-version-upgrade --no-enable-iam-database-authentication --region eu-west-1 --no-multi-az --db-subnet-group-name proupsa-subnet-group --engine-lifecycle-support open-source-rds-extended-support-disabled
```

> Database creation takes a few minutes. You can check the status in the RDS console.

- List RDS instances:

```bash
aws rds describe-db-instances
```

- DB connection details:
  - Endpoint: `proupsa-db.<ID>.eu-west-1.rds.amazonaws.com`
    - Example: `proupsa-db.chs6k6oy68uo.eu-west-1.rds.amazonaws.com`
  - Port: `3306`
  - Username: `admin`
  - Password: `<PASSWORD>`

## Connect to RDS database from EC2 instance

- SSH to EC2 instance:

```bash
ssh -i proupsa-ec2-key-pair.pem ubuntu@<PUBLIC_IP>
```

- Configure MySQL client:

```bash
# root user
sudo -i

# Install mysql client
apt-get update
apt-get install -y mysql-client

# Connect to RDS database
mysql -h proupsa-db.chs6k6oy68uo.eu-west-1.rds.amazonaws.com -P 3306 -u admin -p
```

- Enter the password when prompted.

- MySQL prompt:

```bash
mysql>
```

- List databases:

```sql
SHOW DATABASES;
```

- Create a new database:

```sql
CREATE DATABASE proupsa;
```

- Use the new database:

```sql
USE proupsa;
```

- Create a new table:

```sql
CREATE TABLE users (id INT PRIMARY KEY, name VARCHAR(255));
```

- Insert data into the table:

```sql
INSERT INTO users (id, name) VALUES (1, 'John Doe');
```

- Query the table:

```sql
SELECT * FROM users;
```

- Exit MySQL:

```sql
exit
```

## Delete RDS database

- RDS / Databases / `proupsa-db` / Actions / Delete
  - Delete

```bash
aws rds delete-db-instance --db-instance-identifier proupsa-db --skip-final-snapshot
```
